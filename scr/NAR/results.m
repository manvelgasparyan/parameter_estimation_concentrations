I = [1  5   9  13  17;
     2  6  10  14  18;
     3  7  11  15  19;
     4  8  12  16  20];

Z = eye(12,12);

B1 = [-1  1  0  0  0  0  0  0  0  0 -1  1  0  0  0  0  0  0;  %B
       0  0  0  0  0  0 -1  1  0  0  1 -1  0  0  0  0  0  0;  %A
       0  0  0  0  0  0  0  0  0  0  0  0  0  0 -1  1  0  0;  %I
       0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0;  %D
       1 -1 -1  1  0  0  0  0  0  0  0  0 -1  1  0  0  0  0;  %BL
       0  0  0  0  0  0  1 -1 -1  1  0  0  1 -1  0  0  0  0;  %AL
       0  0  0  0  0  0  0  0  0  0  0  0  0  0  1 -1 -1  1;  %IL
       0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0;  %DL
       0  0  1 -1 -1  1  0  0  0  0  0  0  0  0  0  0  0  0;  %BLL
       0  0  0  0  1 -1  0  0  1 -1  0  0  0  0  0  0  0  0;  %ALL
       0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  1 -1;  %ILL
       0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0]; %DLL

B2 = [ 0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0;  %B
      -1  1  0  0  0  0  0  0  0  0  0  0  0  0  0  0;  %A
       1 -1  0  0  0  0  0  0  0  0 -1  1  0  0  0  0;  %I
       0  0  0  0  0  0 -1  1  0  0  1 -1  0  0  0  0;  %D
       0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0;  %BL
       0  0 -1  1  0  0  0  0  0  0  0  0  0  0  0  0;  %AL
       0  0  1 -1  0  0  0  0  0  0  0  0 -1  1  0  0;  %IL
       0  0  0  0  0  0  1 -1 -1  1  0  0  1 -1  0  0;  %DL
       0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0;  %BLL
       0  0  0  0 -1  1  0  0  0  0  0  0  0  0  0  0;  %ALL
       0  0  0  0  1 -1  0  0  0  0  0  0  0  0 -1  1;  %ILL
       0  0  0  0  0  0  0  0  1 -1  0  0  0  0  1 -1]; %DLL           

Incidence = [B1 B2]; 

H = [1     0     0     0     0     0     0     0     0     0     0     0;
     0     1     0     0     0     0     0     0     0     0     0     0;
     0     0     1     0     0     0     0     0     0     0     0     0;
     0     0     0     1     0     0     0     0     0     0     0     0];

[n,~] = size(H);

x_0 = [100; 0; 20; 0; 0; 8; 0; 4; 3; 0; 5; 9];

k_0 = [3000.000; 8000.000; 1500.000; 16000.000; 30000.000;   700.000; 
       3000.000;    8.640; 1500.000;    17.280;     0.540; 10800.000; 
        130.000; 2740.000; 3000.000;     4.000;  1500.000;     8.000;    
         19.700;    3.740;   19.850;     1.740;    20.000;     0.810; 
       3000.000;    4.000; 1500.000;     8.000;     0.050;     0.001;    
          0.050;    0.001;    0.050;     0.001]; 

T = 0.99*10^(-2);

syms  B A I D
X = [B; A; I; D];

t_interval = 0:T/100:T;

Lambda_2 = [100.000110458268,62.1647216035898,51.8301546998240,45.7124195968194,42.0355417056234,39.7577161613762,38.2828786751383,37.2695070804537,36.5221358634947,35.9291925926639;0.000125976677012884,0.00327975294560092,0.00255564992039534,0.00236190040667717,0.00217137075443399,0.00206777829688487,0.00194458775082592,0.00189740428570557,0.00184954521183479,0.00180322590521757;20.0000063982032,0.744817313363218,0.0304653578387428,0.00196440280317899,0.000499288782891539,0.000421446825479485,0.000347760823787452,0.000427427549519673,0.000277809202103080,0.000438154068539080;0.000122942683823428,0.00178487244776543,0.000501241710874914,0.000272550482956183,0.000195024508395560,0.000269469591747580,0.000220591468575066,0.000108540647959220,0.000216251086568804,0.000237789215387251];

t_span_2 = [0; 0.0011; 0.0022; 0.0033; 0.0044; 0.0055; 0.0066; 0.0077; 0.0088; 0.0099];

k_hat = [2999.99896027355;8000.00302398833;1499.98109222742;16000.0044441603;29999.9976857476;700.132973772090;2952.59411605941;43.0986946837055;1499.85934573742;18.4732267939830;1.37070091821304;10752.4829031308;130.051614995098;2739.91353378711;2999.31160709152;11.4384106247449;1499.97505275055;11.2417197490702;0.250661536949533;3.92897445033624;19.0358949050673;2.39394263347639;15.5112351771944;0.847561023574149;2999.96118191916;5.46371248109681;1499.91950964718;10.0349499846460;0.000108531655040256;8.00018972979381e-08;4.04586108928814e-07;1.45700869689669e-10;3.03024848073719e-09;9.74795518401781e-13];

[t_2, x_2] = Concentrations (k_hat, Z, Incidence, x_0, t_interval);
z_2 = H*x_2;

figure(2)
for i = 1:n
    subplot(2,2,i)
    y_i = Lambda_2(i,:);
    z_i = z_2(i,:);
    plot(t_span_2, y_i, 'x', 'color', 'k', 'linewidth', 1)
    hold on
    plot(t_interval, z_i, 'color', 'k', 'linewidth', 1)
    caption1 = sprintf('Experimental data');
    caption2 = sprintf('Predicted values');
    X_i = char(X(i));
    caption4 = sprintf('Concentration');
    caption3 = sprintf('Reduced model');
    legend(caption1, caption2) 
    xlabel({'Time (sec)'}, 'fontweight','bold', 'Fontsize', 15)
    ylabel(caption4, 'fontweight','bold', 'Fontsize', 15)
    title(X_i, 'fontweight','bold', 'Fontsize', 20)
end
suptitle('Parameter estimation')

[~,r] = size(Incidence);

k = sym('k', [r 1]);

I_del = Deleted_Complexes (H, Z);

phi_k =  Reduced_Parameters (k, Incidence, I_del);

L_red = Schur (k_0, Incidence, I_del);
B_red = Reduced_Incidence (L_red);

reactions = -B_red'*X;

p_hat = [1543.95533190115;498.214100827121;929.945550537862;13681.0562844705;9.53169502268009;0.924507674730931;2701.30324567104;56.5692371215223;1.62541135900908;465.350971951027;1223.84647593534;914.574156865525];

Order = [1 11 9 2 3 7 12 4 5 10 8 6];

reactions = reactions(Order);

P_hat = p_hat(Order);

f = phi_k(Order);

Z_red = Reduced_Complex_Composition(Z, I_del);

y_0 = x_0;
y_0(I_del) = [];

[t_3, x_3] = Concentrations (p_hat, Z_red, B_red, y_0, t_interval);
z_3 = x_3;

figure(1)
for i = 1:n
    subplot(2,2,i)
    y_i = Lambda_2(i,:);
    z_i = z_3(i,:);
    plot(t_span_2, y_i, 'x', 'color', 'k', 'linewidth', 1)
    hold on
    plot(t_interval, z_i, 'color', 'k', 'linewidth', 1)
    caption1 = sprintf('Experimental data');
    caption2 = sprintf('Predicted values');
    X_i = char(X(i));
    caption4 = sprintf('Concentration');
    caption3 = sprintf('Reduced model');
    legend(caption1, caption2) 
    xlabel({'Time (sec)'}, 'fontweight','bold', 'Fontsize', 15)
    ylabel(caption4, 'fontweight','bold', 'Fontsize', 15)
    title(X_i, 'fontweight','bold', 'Fontsize', 20)
end
suptitle('Estimation for the reduced model')
